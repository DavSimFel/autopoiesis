name: CI
on:
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync
      - name: Ruff lint
        run: uv run ruff check . --output-format=github
      - name: Ruff format check
        run: uv run ruff format --check .

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync
      - name: Pyright
        run: uv run pyright

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync
      - name: Run tests
        run: uv run pytest -v --tb=short

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync
      - name: pip-audit
        run: uv run pip-audit
      - name: Bandit
        run: uv run bandit -r . -s B101 --exclude ./.venv,./tests

  spec-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check spec freshness
        run: |
          if [ ! -d "specs/modules" ]; then
            echo "::error::specs/modules directory not found."
            exit 1
          fi

          mapfile -t changed_sources < <(git diff --name-only origin/main...HEAD -- '*.py' ':!tests/**')
          if [ "${#changed_sources[@]}" -eq 0 ]; then
            echo "No Python source changes detected."
            exit 0
          fi

          mapfile -t changed_specs < <(git diff --name-only origin/main...HEAD -- 'specs/')
          declare -A changed_spec_set=()
          for spec_path in "${changed_specs[@]}"; do
            changed_spec_set["$spec_path"]=1
          done

          # Map source files (full relative paths) to their spec files.
          # Works with flat layout (e.g. "chat.py") and nested layout
          # (e.g. "approval/store.py") â€” keys are the paths git reports.
          declare -A source_to_spec=(
            ["chat.py"]="specs/modules/chat.md"
            ["approval/keys.py"]="specs/modules/chat.md"
            ["infra/otel_tracing.py"]="specs/modules/chat.md"
            ["approval/chat_approval.py"]="specs/modules/chat.md"
            ["agent/cli.py"]="specs/modules/chat.md"
            ["agent/runtime.py"]="specs/modules/chat.md"
            ["agent/worker.py"]="specs/modules/chat.md"
            ["model_resolution.py"]="specs/modules/chat.md"
            ["toolset_builder.py"]="specs/modules/chat.md"
            ["db.py"]="specs/modules/memory.md"
            ["approval/store.py"]="specs/modules/chat.md"
            ["approval/store_schema.py"]="specs/modules/chat.md"
            ["agent/context.py"]="specs/modules/context.md"
            ["infra/exec_registry.py"]="specs/modules/exec.md"
            ["tools/exec_tool.py"]="specs/modules/exec.md"
            ["io_utils.py"]="specs/modules/exec.md"
            ["store/history.py"]="specs/modules/memory.md"
            ["store/memory.py"]="specs/modules/memory.md"
            ["tools/memory_tools.py"]="specs/modules/memory.md"
            ["tools/process_tool.py"]="specs/modules/exec.md"
            ["infra/pty_spawn.py"]="specs/modules/exec.md"
            ["display/rich_display.py"]="specs/modules/rich-display.md"
            ["run_simple.py"]="specs/modules/chat.md"
            ["skillmaker_tools.py"]="specs/modules/skillmaker-tools.md"
            ["skills.py"]="specs/modules/skills.md"
            ["display/stream_formatting.py"]="specs/modules/rich-display.md"
            ["display/streaming.py"]="specs/modules/rich-display.md"
            ["server/app.py"]="specs/modules/server.md"
            ["server/connections.py"]="specs/modules/server.md"
            ["server/sessions.py"]="specs/modules/server.md"
            ["server/stream_handle.py"]="specs/modules/server.md"
            ["server/auth.py"]="specs/modules/server.md"
            ["server/models.py"]="specs/modules/server.md"
            ["server/cli.py"]="specs/modules/server.md"
            ["infra/subscription_processor.py"]="specs/modules/subscriptions.md"
            ["tools/subscription_tools.py"]="specs/modules/subscriptions.md"
            ["store/subscriptions.py"]="specs/modules/subscriptions.md"
            ["infra/work_queue.py"]="specs/modules/queue.md"
          )

          missing_specs=()
          for src_path in "${changed_sources[@]}"; do
            # Look up by full relative path
            expected_spec="${source_to_spec[$src_path]-}"
            if [ -z "$expected_spec" ]; then
              # Warn about unmapped source files (skip __init__.py and conftest.py)
              base="$(basename "$src_path")"
              if [ "$base" != "__init__.py" ] && [ "$base" != "conftest.py" ]; then
                echo "::warning::Changed source file has no spec mapping: $src_path"
              fi
              continue
            fi

            if [ ! -f "$expected_spec" ]; then
              missing_specs+=("$src_path -> $expected_spec (missing spec file)")
              continue
            fi

            if [ -z "${changed_spec_set[$expected_spec]+x}" ]; then
              missing_specs+=("$src_path -> $expected_spec")
            fi
          done

          if [ "${#missing_specs[@]}" -gt 0 ]; then
            echo "::error::Python source changed without corresponding spec updates:"
            for missing in "${missing_specs[@]}"; do
              echo "  - $missing"
            done
            exit 1
          fi
