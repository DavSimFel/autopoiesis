name: CI
on:
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync
      - name: Ruff lint
        run: uv run ruff check . --output-format=github
      - name: Ruff format check
        run: uv run ruff format --check .

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync
      - name: Pyright
        run: uv run pyright

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync
      - name: Run tests
        run: uv run pytest -v --tb=short

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync
      - name: pip-audit
        run: uv run pip-audit
      - name: Bandit
        run: uv run bandit -r . -s B101 --exclude .venv

  spec-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check spec freshness
        run: |
          if [ ! -d "specs/modules" ]; then
            echo "::error::specs/modules directory not found."
            exit 1
          fi

          mapfile -t changed_sources < <(git diff --name-only origin/main...HEAD -- '*.py' ':!tests/**')
          if [ "${#changed_sources[@]}" -eq 0 ]; then
            echo "No Python source changes detected."
            exit 0
          fi

          mapfile -t changed_specs < <(git diff --name-only origin/main...HEAD -- 'specs/')
          declare -A changed_spec_set=()
          for spec_path in "${changed_specs[@]}"; do
            changed_spec_set["$spec_path"]=1
          done

          # Map source files (full relative paths) to their spec files.
          # Works with flat layout (e.g. "chat.py") and nested layout
          # (e.g. "approval/store.py") â€” keys are the paths git reports.
          declare -A source_to_spec=(
            ["chat.py"]="specs/modules/chat.md"
            ["approval_keys.py"]="specs/modules/chat.md"
            ["otel_tracing.py"]="specs/modules/chat.md"
            ["chat_approval.py"]="specs/modules/chat.md"
            ["chat_cli.py"]="specs/modules/chat.md"
            ["chat_runtime.py"]="specs/modules/chat.md"
            ["chat_worker.py"]="specs/modules/chat.md"
            ["model_resolution.py"]="specs/modules/chat.md"
            ["toolset_builder.py"]="specs/modules/chat.md"
            ["db.py"]="specs/modules/memory.md"
            ["approval_store.py"]="specs/modules/chat.md"
            ["approval_store_schema.py"]="specs/modules/chat.md"
            ["context_manager.py"]="specs/modules/context.md"
            ["exec_registry.py"]="specs/modules/exec.md"
            ["exec_tool.py"]="specs/modules/exec.md"
            ["io_utils.py"]="specs/modules/exec.md"
            ["history_store.py"]="specs/modules/memory.md"
            ["memory_store.py"]="specs/modules/memory.md"
            ["memory_tools.py"]="specs/modules/memory.md"
            ["process_tool.py"]="specs/modules/exec.md"
            ["pty_spawn.py"]="specs/modules/exec.md"
            ["rich_display.py"]="specs/modules/rich-display.md"
            ["run_simple.py"]="specs/modules/chat.md"
            ["skillmaker_tools.py"]="specs/modules/skillmaker-tools.md"
            ["skills.py"]="specs/modules/skills.md"
            ["stream_formatting.py"]="specs/modules/rich-display.md"
            ["streaming.py"]="specs/modules/rich-display.md"
            ["subscription_processor.py"]="specs/modules/subscriptions.md"
            ["subscription_tools.py"]="specs/modules/subscriptions.md"
            ["subscriptions.py"]="specs/modules/subscriptions.md"
            ["work_queue.py"]="specs/modules/queue.md"
          )

          missing_specs=()
          unmapped_sources=()
          for src_path in "${changed_sources[@]}"; do
            # Look up by full relative path (not basename)
            expected_spec="${source_to_spec[$src_path]-}"
            if [ -z "$expected_spec" ]; then
              unmapped_sources+=("$src_path")
              continue
            fi

            if [ ! -f "$expected_spec" ]; then
              missing_specs+=("$src_path -> $expected_spec (missing spec file)")
              continue
            fi

            if [ -z "${changed_spec_set[$expected_spec]+x}" ]; then
              missing_specs+=("$src_path -> $expected_spec")
            fi
          done

          # Fallback convention for unmapped modules:
          # if <basename>.py has a spec at specs/modules/<basename>.md,
          # that spec must be updated in the same PR.
          for src_path in "${unmapped_sources[@]}"; do
            base_name="${src_path##*/}"
            fallback_spec="specs/modules/${base_name%.py}.md"

            if [ -f "$fallback_spec" ] && [ -z "${changed_spec_set[$fallback_spec]+x}" ]; then
              missing_specs+=("$src_path -> $fallback_spec")
            fi
          done

          if [ "${#missing_specs[@]}" -gt 0 ]; then
            echo "::error::Python source changed without corresponding spec updates:"
            for missing in "${missing_specs[@]}"; do
              echo "  - $missing"
            done
            exit 1
          fi
