name: PR Change Narrative

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  narrative:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Generate narrative
        run: |
          python scripts/pr_narrative.py "origin/${{ github.base_ref }}" > /tmp/narrative.md
          cat /tmp/narrative.md

      - name: Post or update PR comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          MARKER="<!-- change-narrative -->"
          BODY=$(printf '%s\n%s' "$MARKER" "$(cat /tmp/narrative.md)")

          # Find existing comment
          EXISTING=$(gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            --jq ".[] | select(.body | startswith(\"$MARKER\")) | .id" | head -1)

          if [ -n "$EXISTING" ]; then
            gh api "repos/${{ github.repository }}/issues/comments/${EXISTING}" \
              -X PATCH -f body="$BODY"
          else
            gh pr comment "$PR_NUMBER" --body "$BODY"
          fi
